# FinTrackr - Выявленные проблемы и технический долг

## Backend проблемы

### Текущие параллельные задачи (итерация 1)
- [ ] Разбить monolith backend/server.js на модули (routes/controllers/services) с сохранением обратной совместимости (Issues #1, #4).
- [x] Обязательное использование JWT_SECRET из .env с безопасным дефолтом только для тестов (Issue #3).
- [ ] Стандартизировать централизованную обработку ошибок и коды ответов во всех маршрутах (Issues #2, #5).
  - Базовый middleware подключен в Express-приложении, унифицированы ошибки `AppError` (прогресс, требуется распространить на все маршруты).
- [ ] Добавить универсальные middleware для валидации входных данных на всех публичных endpoint'ах (Issue #6).
- [x] Создать единый API-клиент для фронтенда с базовым URL, обработкой ошибок и поддержкой куки (Issue #17).
- [ ] Подготовить скрипт seed данных для демонстрации UI (Issue #31).
- [ ] Расширить README и API документацию для production-ready деплоя (Issues #48, #49).


### Критические

1. **Монолитный server.js**
   - Файл содержит ~2000 строк кода
   - Смешивает ответственности: роутинг, бизнес-логику, утилиты
   - Сложно тестировать и поддерживать
   - **Решение:** Разбить на модули (routes, controllers, services)

2. **Отсутствие централизованной обработки ошибок**
   - Ошибки обрабатываются по-разному в разных endpoint'ах
   - Разные форматы ошибок для клиента
   - Утечка технических деталей клиенту
   - **Решение:** Создать error handling middleware

3. **JWT_SECRET по умолчанию в dev режиме** ✅ **ИСПРАВЛЕНО**
   - Переключено на обязательное значение из .env, с безопасным тестовым запасным вариантом только для `NODE_ENV=test`
   - Добавлено предупреждение при попытке использовать устаревший dev-secret
   - **Решение:** Требовать JWT_SECRET всегда через .env

### Высокий приоритет

4. **Дублирование кода в routes и services**
   - Часть логики в server.js
   - Часть в отдельных routes файлах
   - Часть в services
   - Нет единого подхода
   - **Решение:** Четкое разделение: routes -> controllers -> services

5. **Неконсистентные HTTP статус коды**
   - Разные endpoint'ы возвращают разные коды для похожих ситуаций
   - 200 вместо 201 при создании
   - 500 вместо 400 при валидации
   - **Решение:** Стандартизировать коды ответов
   - [x] Issue #5 - cleaned up duplicate logic in /api/transactions causing downstream 500s and added regression coverage (2025-11-18)

6. **Недостаточная валидация входных данных**
   - Не все поля проверяются
   - Отсутствуют проверки типов и диапазонов
   - Возможны SQL injection (хотя используется SQLite с параметризацией)
   - **Решение:** Добавить middleware валидации для всех endpoint'ов

7. **Неполная реализация CRUD**
   - Не все ресурсы имеют полный набор операций
   - Например, некоторые endpoint'ы только для чтения
   - **Решение:** Дополнить недостающие операции

### Средний приоритет

8. **Два dataService файла**
   - `dataService.js` и `dataService.new.js`
   - Непонятно какой использовать
   - **Решение:** Выбрать один, удалить другой

9. **Отсутствие rate limiting**
   - API не защищен от злоупотреблений
   - **Решение:** Добавить rate limiting middleware

10. **Логирование**
    - Используется console.log
    - Нет структурированного логирования
    - Нет уровней логов
    - **Решение:** Внедрить winston или pino

11. **CORS настройки**
    - Хардкод в коде
    - Нет гибкой конфигурации
    - **Решение:** Вынести в конфигурацию

12. **Миграции БД**
    - Есть schema.sql, но нет системы миграций
    - При изменении схемы нужно вручную обновлять
    - **Решение:** Внедрить систему миграций (например, node-pg-migrate адаптированный для SQLite)

### Низкий приоритет

13. **Currency service кеширование**
    - Курсы валют запрашиваются каждый раз
    - Можно кешировать на несколько часов
    - **Решение:** Добавить кеширование с TTL

14. **Email service**
    - Есть заглушка, но не реализован
    - **Решение:** Интегрировать SendGrid или аналог

15. **ML Analytics Service**
    - Присутствует, но недостаточно данных для обучения
    - **Решение:** Добавить seed данных или упростить модель

## Frontend проблемы

### Критические

16. **Отсутствие единой дизайн-системы**
    - Каждая страница выглядит по-своему
    - Разные отступы, шрифты, цвета
    - Нет CSS переменных для цветовой схемы
    - **Решение:** Создать design tokens (CSS переменные) и единый стиль

17. **Sidebar-top/логотипный блок на всех страницах** ✅ **ИСПРАВЛЕНО**
    - На всех страницах удалён блок sidebar-top, sidebar теперь начинается строго от header
    - Исправлена разметка sidebar на recurring.html (страница регулярных платежей)
    - Проверена и выровнена структура sidebar на всех основных страницах
    - [x] 2025-11-18: Расширенный header и sidebar подключены ко всем страницам кабинета (converter, education, forecast, premium, rules, sync)
    - [x] 2025-11-18: Header переработан под современный финтех UI (поиск, быстрые действия, KPI карты, автообновление метрик)
    - **Решение:** Удалить sidebar-top, унифицировать sidebar markup

### Высокий приоритет

18. **Дублирование кода в routes и services**
   - Часть логики в server.js
   - Часть в отдельных routes файлах
   - Часть в services
   - Нет единого подхода
   - **Решение:** Четкое разделение: routes -> controllers -> services

19. **Неконсистентные HTTP статус коды**
   - Разные endpoint'ы возвращают разные коды для похожих ситуаций
   - 200 вместо 201 при создании
   - 500 вместо 400 при валидации
   - **Решение:** Стандартизировать коды ответов
   - [x] Issue #5 - cleaned up duplicate logic in /api/transactions causing downstream 500s and added regression coverage (2025-11-18)

20. **Несемантичная разметка** ✅ **ЧАСТИЧНО РЕШЕНО**
   - ~~Много `<div>` вместо семантических тегов~~ → Добавлены `<main>`, `<article>`, `<section>`
   - ~~Плохая доступность (a11y)~~ → Добавлены `role="main"`, `aria-label`, `aria-labelledby`
   - **Решение:** Семантические landmarks добавлены в categories.html, accounts.html, transactions.html
   - **Осталось:** Применить к остальным страницам

21. **Sidebar markup/recurring.html bug** ✅ **ИСПРАВЛЕНО**
   - Исправлена некорректная разметка sidebar на recurring.html (страница регулярных платежей)
   - Sidebar теперь корректно отображается и начинается от header
   - **Решение:** Исправить sidebar markup, проверить все страницы

22. **JavaScript модули** ✅ **ЧАСТИЧНО РЕШЕНО**
    - ~~Смешанный подход~~ → Переведены на ES модули: api.js, validation.js, pagination.js
    - ~~Нет четкой структуры импортов~~ → Четкие import/export в categories/accounts/transactions
    - **Решение:** Мигрированы основные модули и 3 страницы
    - **Осталось:** Мигрировать остальные страницы

23. **Отсутствие компонентного подхода**
    - Код для таблиц, форм, карточек повторяется
    - **Решение:** Создать переиспользуемые компоненты/функции

24. **Графики на Canvas**
    - Код рисования сложный и не переиспользуемый
    - **Решение:** Рассмотреть Chart.js или создать простую обертку

### Средний приоритет

25. **Навигация**
    - Меню не адаптируется под мобильные
    - Нет индикации активной страницы
    - **Решение:** Сделать responsive навигацию с бургер-меню

26. **Формы**
    - Нет клиентской валидации
    - Нет показа ошибок рядом с полями
    - **Решение:** Добавить client-side валидацию

27. **Темная тема** ✅ **РЕШЕНО**
   - ~~Заявлена в README, но не везде работает корректно~~ → Исправлен селектор
   - **Решение:** Обновлен селектор в design-system.css на `[data-theme="dark"], .dark`

28. **Accessibility (a11y)** ✅ **ЧАСТИЧНО РЕШЕНО**
   - ~~Отсутствуют aria-labels~~ → Добавлены `aria-label` для main элементов
   - ~~Отсутствуют aria-labelledby~~ → Добавлены для секций контента
   - Плохая навигация с клавиатуры → Требуется дополнительная работа
   - Контрастность цветов не проверена → Требуется аудит
   - **Решение:** ARIA атрибуты добавлены в categories/accounts/transactions, нужен полный a11y audit

### Низкий приоритет

29. **Анимации**
    - Нет плавных переходов
    - UI кажется резким
    - **Решение:** Добавить CSS transitions

30. **Иконки**
    - Разные стили иконок
    - **Решение:** Использовать единый icon set (например, Feather Icons)

31. **Типографика**
    - Неконсистентные размеры шрифтов
    - **Решение:** Создать типографическую шкалу

## База данных проблемы

### Критические

32. **Отсутствие seed данных**
    - Нет данных для демонстрации
    - Сложно тестировать UI
    - **Решение:** Создать скрипт с демо-данными

### Высокий приоритет

33. **Система миграций**
    - Есть schema.sql, но нет версионирования
    - **Решение:** Внедрить миграции

34. **Индексы**
    - Не все часто используемые запросы покрыты индексами
    - **Решение:** Проанализировать запросы и добавить нужные индексы

### Средний приоритет

35. **Нормализация**
    - Некоторые таблицы можно нормализовать лучше
    - Например, валюты могут быть отдельной таблицей
    - **Решение:** Рассмотреть улучшение схемы

36. **Связи**
    - Все связи есть, но можно добавить больше constraints
    - **Решение:** Добавить CHECK constraints где нужно

## Инфраструктура проблемы

### Критические

37. **Отсутствие сборки**
    - Файлы отдаются как есть
    - Нет минификации
    - Нет объединения файлов
    - **Решение:** Настроить Vite или Webpack

38. **PWA**
    - Нет manifest.json
    - Нет service worker
    - Не работает офлайн
    - **Решение:** Внедрить PWA

### Высокий приоритет

39. **Environment variables**
    - Не все настройки через .env
    - **Решение:** Вынести все конфиги в .env

40. **npm scripts**
    - Есть базовые, но не хватает:
      - `build` для продакшен сборки
      - `dev:watch` для auto-reload
    - **Решение:** Дополнить скрипты

41. **Deployment документация**
    - Нет четкой инструкции
    - Не описаны требования к хостингу
    - **Решение:** Написать deployment guide

### Средний приоритет

42. **CI/CD**
    - Нет автоматических проверок
    - **Решение:** Настроить GitHub Actions

43. **Docker**
    - Нет Dockerfile
    - **Решение:** Создать Dockerfile и docker-compose.yml

44. **Lighthouse метрики**
    - Не измерялись
    - **Решение:** Замерить и улучшить

## Тестирование проблемы

### Критические

45. **Падающие тесты** ✅ **РЕШЕНО**
    - ~~14 тестов падают из 52~~ → Все 52 теста проходят
    - `sessionService.test.js` - ✅ исправлены (добавлены методы в dataService, обновлена схема БД)
    - `mlAnalyticsService.test.js` - ✅ исправлены (исправлены имена методов и ожидания тестов)
    - **Решение:** Исправлены тесты и добавлена недостающая функциональность в dataService

### Высокий приоритет

46. **Покрытие кода**
    - Не измеряется
    - Вероятно низкое
    - **Решение:** Настроить coverage reports, увеличить покрытие

47. **E2E тесты**
    - Есть Playwright, но мало тестов
    - **Решение:** Добавить тесты для ключевых сценариев

### Средний приоритет

48. **Integration тесты**
    - Мало тестов интеграции между модулями
    - **Решение:** Добавить integration тесты

## Документация проблемы

### Критические

49. **API документация**
    - Нет описания endpoint'ов
    - Нет примеров запросов/ответов
    - **Решение:** Создать API.md или использовать Swagger

### Высокий приоритет

50. **README неполный**
    - Есть базовая информация
    - Не хватает подробностей по архитектуре, деплою
    - **Решение:** Расширить README

51. **Комментарии в коде**
    - Мало JSDoc комментариев
    - Непонятна логика в некоторых местах
    - **Решение:** Добавить комментарии для сложных мест

### Средний приоритет

52. **Схема БД**
    - Есть SQL, но нет визуальной диаграммы
    - **Решение:** Создать ER-диаграмму


## Приоритизация

### Must Have (Перед демо)
- ~~Проблемы 16, 17, 19~~ ✅ Решено
- ~~Проблема 44~~ ✅ Решено
- Остались: 1, 2, 18, 31, 36, 38, 48

### Should Have (Для production)
- Проблемы 3, 4, 5, 6, 7, 19, 20, 21, 32, 37, 39, 40, 45, 49

### Nice to Have (Для улучшения)
- Все остальные проблемы

## Оценка работ

- Критические проблемы: 10 (✅ решено: 3, ✅ частично: 1)
- Высокий приоритет: 18 (✅ решено: 3, ✅ частично: 4)
- Средний приоритет: 16 (✅ решено: 1)
- Низкий приоритет: 7

**Общее количество выявленных проблем: 51**
**Полностью решено: 7**
**Частично решено: 5**
**Осталось: 39**

---

## Последние изменения (18.11.2025)

### Выполненные работы:
1. **Design System** - Создан `design-system.css` с CSS переменными, подключен ко всем страницам
2. **API Client** - Централизованный клиент `api.js` с унифицированной обработкой ошибок
3. **Loading States** - Добавлены индикаторы загрузки в categories, accounts, transactions
4. **Semantic HTML** - Добавлены landmarks и ARIA атрибуты в 3 основные страницы
5. **Dark Theme** - Исправлен селектор для корректной работы темной темы
6. **Tests** - Все 52 теста проходят успешно
7. **Content Fix** - Исправлен контент about.html (был дубликат регистрации)
8. **Sidebar-top/markup fix** - sidebar-top удалён на всех страницах, sidebar начинается от header, recurring.html markup исправлен

### Технические улучшения:
- Создан `public/js/utils/api.js` - 300+ строк кода
- Рефакторинг `categories.js`, `accounts.js`, `transactions.js` с использованием API клиента
- Удалено ~30+ дублирующихся fetch вызовов
- Унифицирована обработка ошибок (12s timeout, error normalization)
- Добавлены семантические landmarks (`role="main"`, `aria-label`, `aria-labelledby`)
- **ES модули:** Мигрированы api.js, validation.js, pagination.js, categories.js, accounts.js, transactions.js
- **Responsive дизайн:** Создан `responsive-tables.css` - mobile-first подход, таблицы → card view на <768px
- Добавлены `data-label` атрибуты для адаптивных таблиц
- Grid системы: wallet-grid, filter-grid, form-grid, stats-grid с адаптивными breakpoints

## Parallel Task Plan (18.11.2025)

1. **Backend Core & Auth Hardening** (#1, #3, #4, #7, #20, #22) — разбить `server.js` на Express-приложение, довести маршруты/контроллеры/сервисы и усилить JWT/2FA/сессии.
2. **API Safety & Resilience** (#2, #5, #6, #9, #10, #11) — централизованный error handling, валидация, rate limiting, структурное логирование и строгий CORS для всех endpoint'ов.
3. **Data Platform & Persistence** (#8, #12, #18, #31, #32, #33) — объединить варианты `dataService`, добавить миграции/сиды и автоматизацию схем/индексов/бэкапов.
4. **Service Integrations** (#13, #14, #15, #21, #23) — довести currency/email/ML/Canvas модули с TTL, ретраями и мониторингом.
5. **Frontend API Client & State** (#18, #24, #25, #27) — завершить рефактор `api.js`, синхронизировать загрузчики данных, переработать валидацию/лоадеры и пройти a11y-аудит.
6. **UI/UX Polish & Theming** (#24, #26, #28, #29, #30) — закончить responsive‑таблицы, тёмную тему design-system, обновить иконки и микроанимации.
7. **Testing & Automation** (#31, #36, #44, #45, #46, #47) — поднять покрытие Jest, добавить integration + Playwright сценарии, настроить отчёты и npm-скрипты.
8. **Delivery, Infra & Docs** (#36, #37, #38, #39, #40, #41, #42, #43, #48, #49, #50, #51) — закрыть сборщик/PWA, нормализовать env-скрипты, добавить Docker + CI/CD и обновить API/README/ER.
